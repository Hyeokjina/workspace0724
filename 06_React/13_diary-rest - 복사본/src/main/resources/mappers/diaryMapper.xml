<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.board.mapper.DiaryMapper">

    <!-- 전체 일기 조회 -->
    <select id="findAll" resultType="Diary">
        SELECT id, member_id, title, content, emotion, created_at, updated_at
        FROM diary
        ORDER BY created_at DESC
    </select>

    <!-- 회원별 일기 조회 -->
    <select id="findByMemberId" resultType="Diary">
        SELECT id, member_id, title, content, emotion, created_at, updated_at
        FROM diary
        WHERE member_id = #{memberId}
        ORDER BY created_at DESC
    </select>

    <!-- 일기 상세 조회 -->
    <select id="findById" resultType="Diary">
        SELECT id, member_id, title, content, emotion, created_at, updated_at
        FROM diary
        WHERE id = #{id}
    </select>

    <!-- 일기 작성 -->
    <insert id="save" parameterType="Diary" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO diary (member_id, title, content, emotion, created_at, updated_at)
        VALUES (#{memberId}, #{title}, #{content}, #{emotion}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    </insert>

    <!-- 일기 수정 -->
    <update id="updateById" parameterType="Diary">
        UPDATE diary
        SET title = #{title},
            content = #{content},
            emotion = #{emotion},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- 일기 삭제 -->
    <delete id="deleteById">
        DELETE FROM diary
        WHERE id = #{id}
    </delete>

    <!-- 감정별 필터링 (전체) -->
    <select id="findByEmotion" resultType="Diary">
        SELECT id, member_id, title, content, emotion, created_at, updated_at
        FROM diary
        WHERE emotion = #{emotion}
        ORDER BY created_at DESC
    </select>

    <!-- 감정별 필터링 (회원별) -->
    <select id="findByMemberIdAndEmotion" resultType="Diary">
        SELECT id, member_id, title, content, emotion, created_at, updated_at
        FROM diary
        WHERE member_id = #{memberId} AND emotion = #{emotion}
        ORDER BY created_at DESC
    </select>

    <!-- 검색 기능 (전체) -->
    <select id="findByKeyword" resultType="Diary">
        SELECT id, member_id, title, content, emotion, created_at, updated_at
        FROM diary
        WHERE title LIKE CONCAT('%', #{keyword}, '%')
           OR content LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY created_at DESC
    </select>

    <!-- 검색 기능 (회원별) -->
    <select id="findByMemberIdAndKeyword" resultType="Diary">
        SELECT id, member_id, title, content, emotion, created_at, updated_at
        FROM diary
        WHERE member_id = #{memberId}
          AND (title LIKE CONCAT('%', #{keyword}, '%')
           OR content LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY created_at DESC
    </select>

</mapper>
